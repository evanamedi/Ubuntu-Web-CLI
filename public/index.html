<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />
		<title>Docker Management</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	</head>
	<body>
		<button id="start">Start Container</button>
		<button id="stop">Stop Container</button>
		<button id="restart">Restart Container</button>
		<form id="exec-form">
			<input type="text" id="command" placeholder="Enter command" />
			<button type="submit">Execute Command</button>
		</form>
		<div id="output"></div>

		<script>
			// define function to clean output from Docker container
			function cleanOutput(output) {
				// remove all ANSI escape sequences (still trying)
				output = output.replace(/\x1b\[[0-9;]*[A-Za-z]/g, "");
				output = output.replace(/\x1b\].*?\x07/g, "");
				output = output.replace(/[\x00-\x1F\x7F-\x9F]/g, ""); // remove all control characters
				return output;
			}
			//
			//
			// create new WebSocket connection to server
			const ws = new WebSocket("ws://localhost:5000/terminal");
			// create new TextDecoder to decode binary data from Docker container, bc it actually is my problem
			let decoder = new TextDecoder("utf-8", { stream: true });
			//
			//
			// define event handler for when WebSocket connection is opened
			ws.onopen = function () {
				console.log("WebSocket Client Connected");
				// add event listener to 'start' button
				document
					.getElementById("start")
					.addEventListener("click", function () {
						// send get request to '/start' endpoint
						fetch("/start", {
							method: "GET",
							credentials: "same-origin",
						})
							.then((response) => response.text())
							.then((data) => {
								// add response to output
								document.getElementById(
									"output"
								).innerHTML += "<p>" + data + "</p>";
							});
					});
			};
			//
			//
			//
			//
			//
			// define event handler for when message is received from WebSocket server
			ws.onmessage = function (e) {
				if (typeof e.data === "string") {
					try {
						const message = JSON.parse(e.data); // try to parse message as JSON
						if (message.clientId) {
							// if message contains a client ID, store it in cookie
							document.cookie = `clientId=${message.clientId}`;
						} else {
							// else, add message to output
							document.getElementById("output").innerHTML +=
								message + "<br>";
						}
					} catch (error) {
						// if message is not JSON, treat as a plain text and send to output
						document.getElementById("output").innerHTML +=
							e.data + "<br>";
					}
				} else if (e.data instanceof ArrayBuffer) {
					// if message is binary, decode and add it to output
					const text = decoder.decode(e.data);
					const cleanText = cleanOutput(text);
					document.getElementById("output").innerHTML +=
						cleanText + "<br>";
				} else {
					// if message is neither string or binary data, log error
					console.error(
						"Received data is not a string or an ArrayBuffer:",
						e.data
					);
				}
			};
			//
			//
			//
			//
			//
			// add event listener to 'stop' button
			$("#stop").click(function () {
				// send GET request to '/stop' endpoint and add response to output
				$.get("/stop", function (data) {
					$("#output").append("<p>" + data + "</p>");
				});
			});
			//
			//
			//
			//
			//
			// add event listener to 'restart' button
			$("#restart").click(function () {
				// send GET request to '/restart' endpoint and add response to output
				$.get("/restart", function (data) {
					$("#output").append("<p>" + data + "</p>");
				});
			});
			//
			//
			//
			//
			//
			// add event listener to 'exec-form' form
			$("#exec-form").submit(function (e) {
				e.preventDefault();
				// get command form form and send it to the WebSocket server
				const command = $("#command").val();
				ws.send(JSON.stringify({ command: command }));
			});
		</script>
	</body>
</html>
